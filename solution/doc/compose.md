# Обзор конфигурации Docker Compose

В этом документе описаны сервисы и настройки, определённые в файле `docker-compose.yml` для проекта.

---

## Сервисы

### 1. **База данных (PostgreSQL)**
- **Образ**: `postgres:16.6-alpine3.19`
- **Порты**: `5432:5432` (открыт для связи с хостом и между контейнерами)
- **Окружение**: Загружается из файла `.env`.
- **Том**: Постоянное хранилище в `database:/var/lib/postgresql/data`.
- **Проверка работоспособности (Healthcheck)**: Проверяет готовность базы данных с помощью `pg_isready`.
- **Политика перезапуска**: Всегда перезапускается при сбое.

### 2. **Redis**
- **Образ**: `redis:6.2-alpine`
- **Порты**: `6379:6379`
- **Настройки**:
    - Привязывается к адресу `0.0.0.0`.
    - Включает режим append-only с параметром `appendfsync everysec`.
    - Устанавливает пользователя по умолчанию без пароля и с полными правами доступа.
- **Том**: Постоянное хранилище в `redis:/data`.
- **Проверка работоспособности**: Проверяет доступность через `redis-cli ping`.
- **Политика перезапуска**: Перезапускается, если не остановлен вручную.

### 3. **Grafana**
- **Образ**: `grafana/grafana:main`
- **Порты**: `3001:3000` (доступ к панели управления Grafana).
- **Том**: Постоянное хранилище в `grafana:/var/lib/grafana`.

### 4. **Prometheus**
- **Образ**: `prom/prometheus:main`
- **Порты**: `9090:9090`.
- **Тома**:
    - Постоянное хранилище в `prometheus:/prometheus`.
    - Кастомная конфигурация монтируется из файла `./telemetry-configs/prometheus.yml`.
- **Команда**: Включает поддержку нативных гистограмм.

### 5. **Loki (Агрегация логов)**
- **Образ**: `grafana/loki:3.4.1`
- **Порты**: `3100:3100`.
- **Том**: Конфигурация монтируется из файла `./telemetry-configs/loki-config.yaml`.
- **Зависимость**: Зависит от сервиса `minio`.

### 6. **Tempo (Распределённое трассирование)**
- **Образ**: `grafana/tempo:latest`
- **Порты**: `3200:3200`.
- **Тома**:
    - Конфигурация монтируется из файла `./telemetry-configs/tempo-config.yaml`.
    - Постоянное хранилище в `tempo:/var/tempo`.
- **Зависимости**: Зависит от сервисов `minio` и `prometheus`.

### 7. **Mimir (Хранилище метрик)**
- **Образ**: `grafana/mimir:latest`
- **Порты**: `9009:9009`.
- **Том**: Конфигурация монтируется из файла `./telemetry-configs/mimir-config.yaml`.
- **Зависимость**: Зависит от `minio`.

### 8. **OpenTelemetry Collector**
- **Образ**: `otel/opentelemetry-collector-contrib:latest`
- **Порты**: `4317` (gRPC) и `4318` (HTTP) для передачи телеметрических данных.
- **Том**: Конфигурация монтируется из файла `./telemetry-configs/otel-collector-config.yaml`.

### 9. **MinIO (Объектное хранилище)**
- **Образ**: `minio/minio:latest`
- **Порты**: `9000` (API) и `9001` (консоль).
- **Окружение**: Стандартные учетные данные (`minioadmin/minioadmin`).
- **Том**: Постоянное хранилище в `minio:/data`.
- **Команда**: Запускает сервер с доступом к консоли.

### 10. **Init-Buckets (Инициализация бакетов MinIO)**
- **Образ**: `minio/mc`
- **Зависимость**: Зависит от сервиса `minio`.
- **Entrypoint**: Создает бакеты (`loki`, `tempo`, `mimir`, `images`) и устанавливает публичный доступ для бакета `loki`.

### 11. **Backend**
- **Сборка**: Создается из локального Docker-контекста.
- **Порты**: `8080:3000`.
- **Окружение**: Загружается из файла `.env`.
- **Зависимость**: Зависит от сервиса `database` (ожидание прохождения проверки готовности).

### 12. **Migrations (Миграции базы данных)**
- **Сборка**: Использует кастомный `goose.Dockerfile`.
- **Зависимость**: Зависит от сервиса `database` (ожидание прохождения проверки готовности).
- **Окружение**: Загружается из файла `goose.env`.

---

## Тома (Volumes)
Постоянное хранилище данных для критически важных сервисов:
- `database`: Данные PostgreSQL.
- `redis`: Данные Redis.
- `prometheus`: Метрики Prometheus.
- `minio`: Объектное хранилище MinIO.
- `tempo`: Данные трассировки Tempo.
- `grafana`: Панели управления и настройки Grafana.

---

## Зависимости сервисов
- **Loki**, **Tempo**, **Mimir**: Зависит от `minio` для хранения объектов.
- **Backend** и **Migrations**: Зависит от работоспособной базы данных `database`.
- **Tempo**: Также зависит от `prometheus` для сбора метрик.
- **Init-Buckets**: Запускается после инициализации `minio`.

---

## Примечания по конфигурации
1. **Файлы окружения**:
    - `.env` для настроек базы данных и backend.
    - `goose.env` для параметров миграций.
2. **Кастомные конфигурации**:
    - Prometheus, Loki, Tempo, Mimir и OpenTelemetry Collector используют конфигурационные файлы из директории `./telemetry-configs/`.
3. **Проверки работоспособности (Healthchecks)**:
    - База данных и Redis имеют проверки, обеспечивающие корректный запуск зависимых сервисов.
4. **Бакеты MinIO**:
    - Сервис `init-buckets` автоматически создает необходимые бакеты.

---

## Использование
1. **Запуск стека**:
   ```bash
   docker-compose up -d
   ```
